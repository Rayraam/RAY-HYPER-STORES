<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products JSON Generator - RAY HYPER STORE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .file-info {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .processing-section {
            margin: 30px 0;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        .debug-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .debug-info h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .debug-info pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c53030;
            margin: 20px 0;
        }

        .success {
            background: #f0fff4;
            color: #2f855a;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2f855a;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõçÔ∏è Products JSON Generator</h1>
            <p>Convert your spreadsheet data to products.json format for RAY HYPER STORE</p>
        </div>

        <div class="main-content">
            <!-- File Upload Section -->
            <div class="upload-section">
                <h2>üìÅ Upload Your CSV/TSV File</h2>
                <p>Upload your products spreadsheet (CSV or tab-separated values)</p>
                
                <div class="file-upload">
                    <input type="file" id="csvFile" accept=".csv,.tsv,.txt" />
                    <label for="csvFile" class="file-upload-label">
                        Choose File
                    </label>
                </div>
                
                <div id="fileInfo" class="file-info hidden">
                    <strong>Selected File:</strong> <span id="fileName"></span><br>
                    <strong>Size:</strong> <span id="fileSize"></span>
                </div>
            </div>

            <!-- Processing Section -->
            <div class="processing-section">
                <button id="processBtn" class="btn" disabled>
                    <span id="processText">Process File</span>
                </button>
                <button id="downloadBtn" class="btn hidden">
                    üì• Download products.json
                </button>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section hidden">
                <h2>üìä Processing Results</h2>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="categories">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="newProducts">0</div>
                        <div class="stat-label">New Products</div>
                    </div>
                </div>

                <div class="preview">
                    <h3>üìã JSON Preview (first 2 products)</h3>
                    <pre id="jsonPreview"></pre>
                </div>
            </div>

            <!-- Messages -->
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let processedData = null;
        
        // File upload handling
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('processBtn').disabled = false;
            } else {
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('processBtn').disabled = true;
            }
        });

        // Process button handling
        document.getElementById('processBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file first.', 'error');
                return;
            }

            processFile(file);
        });

        // Download button handling
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (processedData) {
                downloadJSON(processedData);
            }
        });

        function processFile(file) {
            showProcessing(true);
            clearMessages();

            // Try different delimiters
            const delimiters = [',', '\t', ';', '|'];
            let bestResult = null;
            let bestDelimiter = ',';

            function tryParse(delimiter, callback) {
                Papa.parse(file, {
                    header: true,
                    delimiter: delimiter,
                    skipEmptyLines: true,
                    complete: function(results) {
                        callback(results, delimiter);
                    }
                });
            }

            // Try each delimiter and pick the best one
            let attempts = 0;
            delimiters.forEach(delimiter => {
                tryParse(delimiter, (results, delim) => {
                    attempts++;
                    
                    if (!bestResult || results.data.length > bestResult.data.length) {
                        bestResult = results;
                        bestDelimiter = delim;
                    }

                    if (attempts === delimiters.length) {
                        // All attempts complete, process with best result
                        processWithResults(bestResult, bestDelimiter);
                    }
                });
            });
        }

        function processWithResults(results, delimiter) {
            try {
                // Show debug information
                showDebugInfo(results, delimiter);

                if (results.errors.length > 0) {
                    console.warn('Parse warnings:', results.errors);
                }

                const jsonData = convertToProductsJSON(results.data);
                processedData = jsonData;
                
                displayResults(jsonData);
                showMessage('‚úÖ File processed successfully!', 'success');
                
            } catch (error) {
                console.error('Processing error:', error);
                showMessage('‚ùå Error processing file: ' + error.message, 'error');
            } finally {
                showProcessing(false);
            }
        }

        function showDebugInfo(results, delimiter) {
            const debugDiv = document.createElement('div');
            debugDiv.className = 'debug-info';
            debugDiv.innerHTML = `
                <h3>üîç File Analysis</h3>
                <p><strong>Delimiter used:</strong> ${delimiter === '\t' ? 'Tab' : delimiter === ',' ? 'Comma' : delimiter}</p>
                <p><strong>Columns detected:</strong> ${results.meta.fields ? results.meta.fields.length : 0}</p>
                <p><strong>Total rows:</strong> ${results.data.length}</p>
                <p><strong>Column headers:</strong></p>
                <pre>${JSON.stringify(results.meta.fields, null, 2)}</pre>
                <p><strong>First row sample:</strong></p>
                <pre>${JSON.stringify(results.data[0], null, 2)}</pre>
            `;
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.appendChild(debugDiv);
        }

        function convertToProductsJSON(data) {
            // Show what we're working with
            console.log('Data sample:', data.slice(0, 2));
            
            // Try to find the correct column names (case-insensitive)
            const firstRow = data[0] || {};
            const columnNames = Object.keys(firstRow);
            
            // Find columns that might contain product numbers
            const productNoColumn = findColumn(columnNames, ['Product_code', 'Product Code', 'Product No', 'ProductNo', 'Product_No', 'SKU', 'Code']);
            const productNameColumn = findColumn(columnNames, ['Product_name', 'Product_name', 'Product Name', 'ProductName', 'Name', 'Title']);
            const mainCategoryColumn = findColumn(columnNames, ['Main_category', 'Main Category', 'MainCategory', 'Main_Category', 'Category']);
            const subCategoryColumn = findColumn(columnNames, ['Sub_Category', 'Sub Category', 'SubCategory', 'Sub_Category', 'Type']);
            const priceColumn = findColumn(columnNames, ['Selling_price', 'Product_price', 'Price', 'Cost', 'Amount']);
            const imageColumn = findColumn(columnNames, ['Image_path', 'Image path', 'Image', 'ImagePath', 'Photo', 'Folder_path']);
            const specsColumn = findColumn(columnNames, ['Specifications', 'Description', 'Details', 'Specs']);
            const companyColumn = findColumn(columnNames, ['Company', 'Brand', 'Manufacturer']);
            const profitColumn = findColumn(columnNames, ['Profit%', 'Profit', 'Margin']);
            const dateColumn = findColumn(columnNames, ['Date', 'Created', 'Updated']);

            console.log('Column mappings:', {
                productNo: productNoColumn,
                productName: productNameColumn,
                mainCategory: mainCategoryColumn,
                subCategory: subCategoryColumn,
                price: priceColumn,
                image: imageColumn,
                specs: specsColumn,
                company: companyColumn,
                profit: profitColumn,
                date: dateColumn
            });

            if (!productNoColumn) {
                throw new Error(`Product number column not found. Available columns: ${columnNames.join(', ')}`);
            }

            // Filter valid products - look for any product codes, not just "SR"
            const validProducts = data.filter(row => {
                const productNo = row[productNoColumn];
                return productNo && productNo.toString().trim().length > 0;
            });

            console.log('Valid products found:', validProducts.length);

            if (validProducts.length === 0) {
                throw new Error(`No products found in column "${productNoColumn}". Check if your data has product codes in this column.`);
            }

            // Convert to products
            const products = validProducts.map((row, index) => {
                const productId = index + 1;
                const mainCategory = row[mainCategoryColumn] || 'Products';
                const subCategory = row[subCategoryColumn] || 'General';
                const priceValue = parseFloat(row[priceColumn] || '0');
                const price = isNaN(priceValue) ? 0 : Math.round(priceValue);
                const image = row[imageColumn] || '';
                const specifications = cleanDescription(row[specsColumn] || '');

                return {
                    id: productId,
                    name: row[productNameColumn] || row[productNoColumn] || `Product ${productId}`,
                    category: mainCategory.toLowerCase() === 'saree' ? 'sarees' : mainCategory.toLowerCase(),
                    subCategory: subCategory,
                    price: price,
                    originalPrice: price,
                    image: image,
                    description: specifications,
                    inStock: true,
                    isNew: productId <= 8,
                    onSale: false,
                    tags: createTags(subCategory)
                };
            });

            // Count categories
            const categoryCount = {};
            validProducts.forEach(row => {
                const subCat = row[subCategoryColumn] || 'General';
                categoryCount[subCat] = (categoryCount[subCat] || 0) + 1;
            });

            // Create main categories
            const mainCategories = {};
            products.forEach(product => {
                if (!mainCategories[product.category]) {
                    mainCategories[product.category] = {
                        id: product.category,
                        name: product.category.charAt(0).toUpperCase() + product.category.slice(1),
                        count: 0,
                        description: `${product.category.charAt(0).toUpperCase() + product.category.slice(1)} for every occasion`,
                        subCategories: {}
                    };
                }
                mainCategories[product.category].count++;
                
                // Count subcategories within each main category
                if (!mainCategories[product.category].subCategories[product.subCategory]) {
                    mainCategories[product.category].subCategories[product.subCategory] = 0;
                }
                mainCategories[product.category].subCategories[product.subCategory]++;
            });

            // Convert subcategories to array format
            Object.values(mainCategories).forEach(mainCat => {
                mainCat.subCategories = Object.entries(mainCat.subCategories).map(([name, count]) => ({
                    id: name.toLowerCase().replace(/[^a-z0-9]/g, ''),
                    name: name,
                    count: count
                }));
            });

            // Create final JSON structure
            return {
                products: products,
                categories: Object.values(mainCategories),
                storeInfo: {
                    name: "RAY HYPER STORE",
                    description: "Premium Sarees and Jewelry Store",
                    whatsappNumber: "919698639115",
                    email: "contact.rayraam@gmail.com",
                    address: "119, Shakespear street, Eastham, London, United Kingdom E12 6LW",
                    totalProducts: products.length,
                    lastUpdated: new Date().toISOString().split('T')[0],
                    currencies: {
                        supported: ["INR", "GBP", "USD", "CAD", "EUR", "LKR"],
                        default: "INR",
                        exchangeRates: {
                            INR: 1,
                            GBP: 0.0087,
                            USD: 0.0113,
                            CAD: 0.0156,
                            EUR: 0.0095,
                            LKR: 3.44
                        }
                    }
                }
            };
        }

        function findColumn(columnNames, possibleNames) {
            for (const possible of possibleNames) {
                const found = columnNames.find(col => 
                    col.toLowerCase().trim() === possible.toLowerCase().trim()
                );
                if (found) return found;
            }
            return null;
        }

        function createTags(subCategory) {
            if (subCategory.includes('Kalyani Cotton')) {
                return ["cotton", "paithani", "traditional", "handloom", "kalyani cotton", "jari work"];
            } else if (subCategory.includes('Elite Korvai')) {
                return ["silk", "bridal", "wedding", "elite", "korvai", "luxury", "embossed"];
            } else if (subCategory.includes('Kanchipuram')) {
                return ["silk", "kanchipuram", "traditional", "wedding", "premium"];
            } else if (subCategory.includes('Cotton')) {
                return ["cotton", "comfortable", "daily wear", "handloom"];
            } else if (subCategory.includes('Silk')) {
                return ["silk", "elegant", "party wear", "premium"];
            }
            
            return ["saree", "traditional", "handloom"];
        }

        function cleanDescription(description) {
            if (!description) return '';
            
            return description
                .replace(/"/g, '')
                .replace(/\n\n/g, ' ')
                .replace(/\n/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function displayResults(jsonData) {
            // Update stats
            document.getElementById('totalProducts').textContent = jsonData.products.length;
            document.getElementById('categories').textContent = jsonData.categories.reduce((total, cat) => total + cat.subCategories.length, 0);
            document.getElementById('newProducts').textContent = jsonData.products.filter(p => p.isNew).length;

            // Show preview of first 2 products
            const preview = {
                ...jsonData,
                products: jsonData.products.slice(0, 2)
            };
            document.getElementById('jsonPreview').textContent = JSON.stringify(preview, null, 2);

            // Show results section and download button
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
        }

        function downloadJSON(data) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'products.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('‚úÖ products.json downloaded successfully!', 'success');
        }

        function showProcessing(show) {
            const processBtn = document.getElementById('processBtn');
            const processText = document.getElementById('processText');
            
            if (show) {
                processBtn.disabled = true;
                processText.innerHTML = '<span class="loading"></span>Processing...';
            } else {
                processBtn.disabled = false;
                processText.textContent = 'Process File';
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>